<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="theme-color" content="#ff6b6b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Noor's Games">
    <title>Kleuren</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üé®</text></svg>">
    <link rel="manifest" href="../manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Nunito:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="shared.css">
    <style>
        /* ‚îÄ‚îÄ Selection screen (inside .game-container) ‚îÄ‚îÄ */
        .page-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            padding: 10px 0;
        }

        .page-card {
            background: #fff;
            border: 3px solid #eee;
            border-radius: 16px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .page-card:hover {
            border-color: #ff6b6b;
            transform: scale(1.03);
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.25);
        }

        .page-card:active {
            transform: scale(0.97);
        }

        .page-thumb {
            width: 100%;
            aspect-ratio: 1;
            object-fit: contain;
            border-radius: 10px;
            background: #fafafa;
            pointer-events: none;
        }

        .page-name {
            margin-top: 6px;
            font-family: 'Fredoka One', cursive;
            font-size: 0.85rem;
            color: #555;
        }

        .empty-state {
            color: #999;
            font-size: 0.95rem;
            padding: 40px 10px;
        }

        /* ‚îÄ‚îÄ Fullscreen coloring screen ‚îÄ‚îÄ */
        .color-fullscreen {
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
        }

        /* ‚îÄ‚îÄ Top bar ‚îÄ‚îÄ */
        .color-topbar {
            height: 48px;
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 1px 8px rgba(0, 0, 0, 0.08);
            z-index: 10;
        }

        .color-topbar-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #ff9a8b;
            color: white;
            border: none;
            padding: 7px 14px;
            border-radius: 12px;
            font-family: 'Fredoka One', cursive;
            font-size: 0.85rem;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            transition: all 0.2s ease;
        }

        .color-topbar-btn:hover {
            background: #ff6b6b;
            transform: scale(1.05);
        }

        .color-topbar-btn:active {
            transform: scale(0.95);
        }

        .color-toggle-btn {
            background: #fff;
            color: #333;
            border: 2px solid #eee;
        }

        .color-toggle-btn:hover {
            background: #fff5f5;
            border-color: #ff6b6b;
        }

        .color-toggle-btn.active {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .color-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(0, 0, 0, 0.15);
            vertical-align: middle;
            flex-shrink: 0;
        }

        /* ‚îÄ‚îÄ Canvas area ‚îÄ‚îÄ */
        .color-canvas-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            padding: 10px;
            position: relative;
        }

        .drawing-canvas {
            border-radius: 10px;
            cursor: crosshair;
            display: block;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            background: white;
        }

        /* ‚îÄ‚îÄ Flyout panel (right side) ‚îÄ‚îÄ */
        .color-flyout {
            position: absolute;
            top: 48px;
            right: 0;
            bottom: 0;
            width: 190px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            box-shadow: -3px 0 20px rgba(0, 0, 0, 0.1);
            z-index: 5;
            padding: 18px 14px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
        }

        .color-flyout.open {
            transform: translateX(0);
        }

        .color-flyout-header {
            font-family: 'Fredoka One', cursive;
            font-size: 0.95rem;
            color: #e63946;
            text-align: center;
        }

        .color-flyout-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            justify-items: center;
        }

        .color-btn {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            transition: all 0.15s ease;
        }

        .color-btn:hover {
            transform: scale(1.15);
        }

        .color-btn.selected {
            border-color: #333;
            transform: scale(1.2);
            box-shadow: 0 0 0 2px #333;
        }

        .color-flyout-tools {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: auto;
            padding-top: 10px;
        }

        .tool-btn {
            background: linear-gradient(180deg, #ff7675 0%, #d63031 100%);
            border: none;
            padding: 10px 14px;
            border-radius: 12px;
            font-family: 'Fredoka One', cursive;
            font-size: 0.8rem;
            color: white;
            cursor: pointer;
            box-shadow: 0 3px 0 rgba(0, 0, 0, 0.15);
            transition: all 0.2s ease;
            width: 100%;
            text-align: center;
        }

        .tool-btn:hover {
            transform: scale(1.05);
        }

        .tool-btn:active {
            transform: translateY(2px);
            box-shadow: 0 1px 0 rgba(0, 0, 0, 0.15);
        }

        /* ‚îÄ‚îÄ Expand animation (thumbnail ‚Üí fullscreen) ‚îÄ‚îÄ */
        .color-fullscreen.animating-in {
            animation: expandToFullscreen 0.45s cubic-bezier(0.4, 0, 0.2, 1) forwards;
            border-radius: 16px;
            overflow: hidden;
        }

        @keyframes expandToFullscreen {
            0% {
                top: var(--start-top);
                left: var(--start-left);
                width: var(--start-width);
                height: var(--start-height);
                border-radius: 16px;
                opacity: 0.85;
            }
            100% {
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                border-radius: 0;
                opacity: 1;
            }
        }

        /* ‚îÄ‚îÄ Exit animation (reuse shared.css gameExitOut) ‚îÄ‚îÄ */
        .color-fullscreen.color-exit {
            animation: gameExitOut 0.3s ease-in forwards;
        }

        /* ‚îÄ‚îÄ Flyout overlay tap-to-close (mobile-friendly) ‚îÄ‚îÄ */
        .color-flyout-backdrop {
            display: none;
            position: absolute;
            top: 48px;
            left: 0;
            right: 190px;
            bottom: 0;
            z-index: 4;
        }

        .color-flyout-backdrop.active {
            display: block;
        }

        /* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
        @media (min-width: 768px) {
            .page-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 15px;
            }

            .color-topbar {
                height: 52px;
                padding: 0 20px;
            }

            .color-topbar-btn {
                padding: 8px 18px;
                font-size: 0.9rem;
            }

            /* Sidebar always visible on tablet */
            .color-toggle-btn {
                display: none;
            }

            .color-flyout {
                top: 52px;
                width: 210px;
                padding: 20px 16px;
                transform: translateX(0);
                box-shadow: -1px 0 10px rgba(0, 0, 0, 0.06);
            }

            .color-canvas-area {
                margin-right: 210px;
            }

            /* No backdrop needed on tablet */
            .color-flyout-backdrop {
                display: none !important;
            }

            .color-btn {
                width: 38px;
                height: 38px;
            }

            .tool-btn {
                padding: 10px 16px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>
<body>
    <!-- ‚îÄ‚îÄ Selection screen (inside .game-container) ‚îÄ‚îÄ -->
    <div class="game-container" id="gameContainer">
        <a href="../index.html" class="back-btn">üè† Terug</a>
        <h1>üé® Kleuren</h1>

        <div id="selectScreen">
            <div class="page-grid" id="pageGrid">
                <div class="empty-state">Kleurplaten laden...</div>
            </div>
        </div>
    </div>

    <!-- ‚îÄ‚îÄ Fullscreen coloring screen (OUTSIDE .game-container) ‚îÄ‚îÄ -->
    <div id="colorScreen" class="color-fullscreen" style="display:none">
        <div class="color-topbar">
            <button class="color-topbar-btn" onclick="showSelection()">üè† Terug</button>
            <button class="color-topbar-btn color-toggle-btn" id="paletteToggle" onclick="togglePalette()">
                <span class="color-indicator" id="colorIndicator"></span>
                üé®
            </button>
        </div>

        <div class="color-canvas-area">
            <canvas id="canvas" class="drawing-canvas"></canvas>
        </div>

        <!-- Tap-to-close backdrop when flyout is open -->
        <div class="color-flyout-backdrop" id="flyoutBackdrop" onclick="togglePalette()"></div>

        <div class="color-flyout" id="colorFlyout">
            <div class="color-flyout-header">Kies een kleur</div>
            <div class="color-flyout-grid" id="palette"></div>
            <div class="color-flyout-tools">
                <button class="tool-btn" onclick="resetCanvas()">Opnieuw</button>
                <button class="tool-btn" onclick="showSelection()">Andere kleurplaat</button>
            </div>
        </div>
    </div>

    <script src="shared.js"></script>
    <script>
        /* ‚îÄ‚îÄ Config ‚îÄ‚îÄ */
        const colors = [
            '#FF6B6B', '#FF8E8E', '#FFB5B5', '#FFD5D5',
            '#FFE66D', '#FFA500', '#96CEB4', '#4ECDC4',
            '#45B7D1', '#74B9FF', '#A29BFE', '#DDA0DD',
            '#F0F0F0', '#A9A9A9', '#8B4513', '#2D2D2D'
        ];

        let selectedColor = colors[0];

        const canvas  = document.getElementById('canvas');
        const ctx     = canvas.getContext('2d');

        /* ‚îÄ‚îÄ State ‚îÄ‚îÄ */
        let currentImg = null;   // loaded Image element
        let svgRatio   = 1;      // width / height from SVG viewBox

        /* ‚îÄ‚îÄ DOM refs ‚îÄ‚îÄ */
        const gameContainer  = document.getElementById('gameContainer');
        const selectScreen   = document.getElementById('selectScreen');
        const colorScreen    = document.getElementById('colorScreen');
        const colorFlyout    = document.getElementById('colorFlyout');
        const flyoutBackdrop = document.getElementById('flyoutBackdrop');
        const paletteToggle  = document.getElementById('paletteToggle');
        const colorIndicator = document.getElementById('colorIndicator');

        /* ‚îÄ‚îÄ Topbar height helper ‚îÄ‚îÄ */
        function getTopbarHeight() {
            return window.innerWidth >= 768 ? 52 : 48;
        }

        /* ‚îÄ‚îÄ Screen management ‚îÄ‚îÄ */
        function showSelection() {
            // Close flyout if open
            closePalette();

            // Play exit animation on fullscreen color screen
            colorScreen.classList.add('color-exit');
            setTimeout(() => {
                colorScreen.style.display = 'none';
                colorScreen.classList.remove('color-exit', 'animating-in');
                gameContainer.style.display = '';
            }, 300);
        }

        function showColoring() {
            gameContainer.style.display = 'none';
            colorScreen.style.display = 'flex';
        }

        /* ‚îÄ‚îÄ Flyout palette toggle ‚îÄ‚îÄ */
        function togglePalette() {
            const isOpen = colorFlyout.classList.toggle('open');
            flyoutBackdrop.classList.toggle('active', isOpen);
            paletteToggle.classList.toggle('active', isOpen);
        }

        function closePalette() {
            colorFlyout.classList.remove('open');
            flyoutBackdrop.classList.remove('active');
            paletteToggle.classList.remove('active');
        }

        /* ‚îÄ‚îÄ Load page index and build thumbnails ‚îÄ‚îÄ */
        async function loadPages() {
            const grid = document.getElementById('pageGrid');
            try {
                const resp = await fetch('../kleurplaten/index.json');
                const data = await resp.json();

                if (!data.pages || data.pages.length === 0) {
                    grid.innerHTML = '<div class="empty-state">Nog geen kleurplaten gevonden</div>';
                    return;
                }

                grid.innerHTML = '';
                data.pages.forEach(page => {
                    const card = document.createElement('div');
                    card.className = 'page-card';
                    card.onclick = () => openPage(page.file, card);

                    const img = document.createElement('img');
                    img.className = 'page-thumb';
                    img.src = '../kleurplaten/' + page.file;
                    img.alt = page.name;
                    img.loading = 'lazy';

                    const name = document.createElement('div');
                    name.className = 'page-name';
                    name.textContent = page.name;

                    card.appendChild(img);
                    card.appendChild(name);
                    grid.appendChild(card);
                });
            } catch (e) {
                grid.innerHTML = '<div class="empty-state">Kon kleurplaten niet laden</div>';
            }
        }

        /* ‚îÄ‚îÄ Open a coloring page with expand animation ‚îÄ‚îÄ */
        function openPage(file, cardElement) {
            const img = new Image();
            img.onload = () => {
                currentImg = img;
                svgRatio = img.naturalWidth / img.naturalHeight || 1;

                // Get thumbnail position for expand animation
                if (cardElement) {
                    const rect = cardElement.getBoundingClientRect();
                    colorScreen.style.setProperty('--start-top', rect.top + 'px');
                    colorScreen.style.setProperty('--start-left', rect.left + 'px');
                    colorScreen.style.setProperty('--start-width', rect.width + 'px');
                    colorScreen.style.setProperty('--start-height', rect.height + 'px');
                }

                initPalette();
                updateColorIndicator();

                // Show the fullscreen overlay with animation
                colorScreen.style.display = 'flex';
                colorScreen.classList.add('animating-in');
                gameContainer.style.display = 'none';

                // After animation completes, size canvas and render
                const onEnd = () => {
                    colorScreen.removeEventListener('animationend', onEnd);
                    colorScreen.classList.remove('animating-in');
                    sizeCanvas();
                    drawFresh();
                };
                colorScreen.addEventListener('animationend', onEnd);

                // Fallback in case animationend doesn't fire
                setTimeout(() => {
                    if (colorScreen.classList.contains('animating-in')) {
                        colorScreen.classList.remove('animating-in');
                        sizeCanvas();
                        drawFresh();
                    }
                }, 600);
            };
            img.onerror = () => {
                alert('Kon de kleurplaat niet laden');
            };
            img.src = '../kleurplaten/' + file;
        }

        /* ‚îÄ‚îÄ Size canvas to fill the fullscreen viewport ‚îÄ‚îÄ */
        function getSidebarWidth() {
            return window.innerWidth >= 768 ? 210 : 0;
        }

        function sizeCanvas() {
            const topbarH = getTopbarHeight();
            const sidebarW = getSidebarWidth();
            const padding = 15; // breathing room around canvas

            const availW = window.innerWidth - sidebarW - (padding * 2);
            const availH = window.innerHeight - topbarH - (padding * 2);

            let w = availW;
            let h = w / svgRatio;

            if (h > availH) {
                h = availH;
                w = h * svgRatio;
            }

            w = Math.max(Math.round(w), 100);
            h = Math.max(Math.round(h), 100);

            // Only re-render if size actually changed
            if (canvas.width !== w || canvas.height !== h) {
                canvas.width  = w;
                canvas.height = h;
                canvas.style.width  = w + 'px';
                canvas.style.height = h + 'px';
                drawFresh();
            }
        }

        /* ‚îÄ‚îÄ Resize listener ‚îÄ‚îÄ */
        window.addEventListener('resize', () => {
            if (colorScreen.style.display !== 'none' && currentImg) {
                sizeCanvas();
            }
        });

        /* ‚îÄ‚îÄ Drawing ‚îÄ‚îÄ */
        function drawFresh() {
            ctx.fillStyle = '#fff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            if (currentImg) {
                ctx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);
            }
        }

        function redrawOutlines() {
            if (!currentImg) return;
            const tmpCanvas = document.createElement('canvas');
            tmpCanvas.width = canvas.width;
            tmpCanvas.height = canvas.height;
            const tmpCtx = tmpCanvas.getContext('2d');
            tmpCtx.drawImage(currentImg, 0, 0, canvas.width, canvas.height);

            const src  = tmpCtx.getImageData(0, 0, canvas.width, canvas.height).data;
            const main = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const dst  = main.data;

            for (let i = 0; i < src.length; i += 4) {
                if (src[i] < 60 && src[i+1] < 60 && src[i+2] < 60 && src[i+3] > 128) {
                    dst[i]   = src[i];
                    dst[i+1] = src[i+1];
                    dst[i+2] = src[i+2];
                    dst[i+3] = 255;
                }
            }
            ctx.putImageData(main, 0, 0);
        }

        function resetCanvas() {
            drawFresh();
        }

        /* ‚îÄ‚îÄ Color palette ‚îÄ‚îÄ */
        function initPalette() {
            const palette = document.getElementById('palette');
            palette.innerHTML = '';
            colors.forEach((color, i) => {
                const btn = document.createElement('button');
                btn.className = 'color-btn' + (i === 0 ? ' selected' : '');
                btn.style.backgroundColor = color;
                btn.onclick = () => {
                    selectedColor = color;
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('selected'));
                    btn.classList.add('selected');
                    updateColorIndicator();
                };
                palette.appendChild(btn);
            });
            selectedColor = colors[0];
        }

        function updateColorIndicator() {
            colorIndicator.style.backgroundColor = selectedColor;
        }

        /* ‚îÄ‚îÄ Flood fill ‚îÄ‚îÄ */
        function floodFill(startX, startY, fillColor) {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const w = canvas.width;
            const h = canvas.height;

            const startPos = (startY * w + startX) * 4;
            const startR = data[startPos];
            const startG = data[startPos + 1];
            const startB = data[startPos + 2];

            // Don't fill outlines
            if (startR < 60 && startG < 60 && startB < 60) return;

            const fillR = parseInt(fillColor.slice(1, 3), 16);
            const fillG = parseInt(fillColor.slice(3, 5), 16);
            const fillB = parseInt(fillColor.slice(5, 7), 16);

            // Already this color
            if (startR === fillR && startG === fillG && startB === fillB) return;

            const tolerance = 50;

            function matches(pos) {
                return Math.abs(data[pos]   - startR) <= tolerance &&
                       Math.abs(data[pos+1] - startG) <= tolerance &&
                       Math.abs(data[pos+2] - startB) <= tolerance;
            }

            function isBorder(pos) {
                return data[pos] < 60 && data[pos+1] < 60 && data[pos+2] < 60;
            }

            const stack = [[startX, startY]];
            const visited = new Set();

            while (stack.length > 0) {
                const [x, y] = stack.pop();
                const key = (y * w + x);

                if (visited.has(key)) continue;
                if (x < 0 || x >= w || y < 0 || y >= h) continue;

                const pos = key * 4;
                if (isBorder(pos)) continue;
                if (!matches(pos)) continue;

                visited.add(key);

                data[pos]     = fillR;
                data[pos + 1] = fillG;
                data[pos + 2] = fillB;
                data[pos + 3] = 255;

                stack.push([x + 1, y]);
                stack.push([x - 1, y]);
                stack.push([x, y + 1]);
                stack.push([x, y - 1]);
            }

            ctx.putImageData(imageData, 0, 0);
            redrawOutlines();
        }

        /* ‚îÄ‚îÄ Click handler ‚îÄ‚îÄ */
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = Math.floor((e.clientX - rect.left) * scaleX);
            const y = Math.floor((e.clientY - rect.top) * scaleY);
            floodFill(x, y, selectedColor);
        });

        /* ‚îÄ‚îÄ Init ‚îÄ‚îÄ */
        loadPages();
        updateColorIndicator();
    </script>
</body>
</html>
